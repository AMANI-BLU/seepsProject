{% extends 'student_template/base.html' %}

{% block title %}Exam Detail{% endblock %}

{% block content %}
<div class="container mt-5">
  <div class="card shadow p-3 mb-5 bg-white rounded">
    <div class="card-header bg-info text-white text-center">
      <h5>{{ exam.name }} - Exam</h5>
    </div>
    <div class="card-body">
      <div class="text-center">
        <span id="timer">Time Remaining: {{ exam.timer }}:00</span>
      </div>
      <!-- Progress bar -->
      <div class="progress mt-3 mb-3">
        <div id="timerProgressBar" class="progress-bar bg-info" role="progressbar" style="width: 100%;" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
      </div>
      <!-- Your exam content here -->
    <form id="examForm" method="post" action="{% url 'submit_exam' exam.id %}" onsubmit="handleSubmit()">
        {% csrf_token %}
     {% for question in questions %}
  <div class="card card-info mb-4">
    <div class="card-header">
      <h4 class="card-title mb-0">{{ forloop.counter }}) {{ question.content|slice:"3:"|safe }}</h4>
    </div>
    <div class="card-body">
      <div class="list-group">
        {% for choice in question.choice_set.all %}
          <label class="list-group-item list-group-item-action">
            <div class="icheck-info d-inline">
              <input type="radio" id="choice{{ choice.id }}" name="question_{{ question.id }}" value="{{ choice.id }}">
              <label for="choice{{ choice.id }}">{{ choice.text }}</label>
            </div>
          </label>
        {% endfor %}
      </div>
    </div>
  </div>
{% endfor %}

        
        <div class="text-center">
          <button type="submit" onclick="handleSubmit()" class="btn btn-info btn-lg">
            <i class="fas fa-check-circle"></i> Submit Exam
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // Function to handle form submission
  function handleSubmit() {
    // Clear progress data from localStorage
    localStorage.removeItem('examProgress');
    localStorage.removeItem('timerValue'); // Remove timer value from localStorage
  }

  var timerElement = document.getElementById('timer');
  var progressBar = document.getElementById('timerProgressBar');
  var timerValue = localStorage.getItem('timerValue') ? parseInt(localStorage.getItem('timerValue')) : {{ exam.timer }} * 60;

  function updateTimer() {
    var minutes = Math.floor(timerValue / 60);
    var seconds = timerValue % 60;
    var progressPercentage = (timerValue / ({{ exam.timer }} * 60)) * 100;

    // Set timer text content
    timerElement.textContent = 'Time Remaining: ' + String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
    
    // Set progress bar width
    progressBar.style.width = progressPercentage + '%';

    // Change progress bar color to red when 3 minutes left
    if (timerValue <= 180) {
      progressBar.classList.add('bg-danger');
    }

    if (timerValue === 0) {
      document.getElementById('examForm').submit();
      localStorage.removeItem('examProgress');
      localStorage.removeItem('timerValue');
    } else {
      timerValue--;
      localStorage.setItem('timerValue', timerValue); // Store timer value in localStorage
      setTimeout(updateTimer, 1000);
    }

    // Auto-save progress every 5 seconds
    if (timerValue % 5 === 0) {
      saveProgress();
    }
  }

  updateTimer();

  // Save progress
  function saveProgress() {
    const selectedAnswers = {};
    {% for question in questions %}
      var selectedOption = document.querySelector('input[name="question_{{ question.id }}"]:checked');
      if (selectedOption) {
        selectedAnswers[{{ question.id }}] = selectedOption.value;
      }
    {% endfor %}
    const progressData = {
      selectedAnswers: selectedAnswers
    };
    localStorage.setItem('examProgress', JSON.stringify(progressData));
  }

  // Load progress
  function loadProgress() {
    const savedProgress = localStorage.getItem('examProgress');
    if (savedProgress) {
      const progressData = JSON.parse(savedProgress);
      for (const questionId in progressData.selectedAnswers) {
        const selectedOptionValue = progressData.selectedAnswers[questionId];
        document.querySelector('input[name="question_' + questionId + '"][value="' + selectedOptionValue + '"]').checked = true;
      }
    }
  }

  // Auto-load progress on page load
  loadProgress();

  // Code to prevent navigation away, opening new tabs, fullscreen...
</script>

{% endblock %}
