{% extends 'student_template/base.html' %}

{% block title %}Exam Detail{% endblock %}

{% block content %}
<div class="container mt-5">
  <div class="card shadow p-3 mb-5 bg-white rounded">
    <div class="card-header bg-info text-white text-center">
      <h5>{{ exam.name }} - Exam</h5>
    </div>
    <div class="card-body">
      <div class="text-center">
        <span id="timer">Time Remaining: {{ exam.timer }}:00</span>
      </div>
      <!-- Progress bar -->
      <div class="progress mt-3 mb-3">
        <div id="timerProgressBar" class="progress-bar bg-info" role="progressbar" style="width: 100%;" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
      </div>
      <!-- Your exam content here -->
      <form id="examForm" method="post" action="{% url 'submit_exam' exam.id %}">
        {% csrf_token %}
       {% for question in questions %}
  <div class="mb-4">
<h4>{{ forloop.counter }}) {{ question.content|slice:"3:"|safe }}</h4>
    <div class="list-group">
      {% for choice in question.choice_set.all %}
        <label class="list-group-item list-group-item-action">
          <input type="radio" name="question_{{ question.id }}" value="{{ choice.id }}">
          {{ choice.text }}
        </label>
      {% endfor %}
    </div>
  </div>
{% endfor %}

        <div class="text-center">
          <button type="submit" class="btn btn-info btn-lg">
            <i class="fas fa-check-circle"></i> Submit Exam
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Button to enter fullscreen -->
<button id="fullscreenButton" class="btn btn-primary" onclick="openFullscreen()">Enter Fullscreen</button>

<!-- SweetAlert library -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- JavaScript to prevent navigation away, opening new tabs, fullscreen, and update timer -->
<script>
  // Fullscreen mode
  function openFullscreen() {
    var elem = document.documentElement;
    if (elem.requestFullscreen) {
      elem.requestFullscreen();
    } else if (elem.mozRequestFullScreen) { /* Firefox */
      elem.mozRequestFullScreen();
    } else if (elem.webkitRequestFullscreen) { /* Chrome, Safari and Opera */
      elem.webkitRequestFullscreen();
    } else if (elem.msRequestFullscreen) { /* IE/Edge */
      elem.msRequestFullscreen();
    }
  }

  // Timer
  var timerElement = document.getElementById('timer');
  var progressBar = document.getElementById('timerProgressBar');
  var timer = {{ exam.timer }} * 60;

  function updateTimer() {
    var minutes = Math.floor(timer / 60);
    var seconds = timer % 60;
    var progressPercentage = (timer / ({{ exam.timer }} * 60)) * 100;

    // Set timer text content
    timerElement.textContent = 'Time Remaining: ' + String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
    
    // Set progress bar width
    progressBar.style.width = progressPercentage + '%';

    // Change progress bar color to red when 3 minutes left
    if (timer <= 120) {
      progressBar.classList.add('bg-danger');
    }

    if (timer === 0) {
      document.getElementById('examForm').submit();
    } else {
      timer--;
      setTimeout(updateTimer, 1000);
    }
  }

  updateTimer();

  // Disable right-click context menu
  window.addEventListener('contextmenu', function(event) {
    event.preventDefault();
    showMessage('Right-click context menu is disabled during the exam.');
  });

  // Disable keyboard shortcuts
  window.addEventListener('keydown', function(event) {
    event.preventDefault();
    showMessage('Keyboard shortcuts are disabled during the exam.');
  });

  // Prevent navigating away from the exam page
  window.onbeforeunload = function(event) {
    return 'Are you sure you want to leave this page? Your exam progress will be lost.';
  };

  // Prevent opening new tabs or windows
  window.open = function() {
    showMessage('Opening new tabs or windows is disabled during the exam.');
    return false;
  };

  // Prevent refreshing the page
  window.addEventListener('beforeunload', function(event) {
    event.preventDefault();
    showMessage('Refreshing the page is disabled during the exam.');
  });

  // Prevent exiting fullscreen with the Escape key
  document.addEventListener('fullscreenchange', function(event) {
    if (!document.fullscreenElement) {
      openFullscreen(); // Re-enter fullscreen if user exits
    }
  });

  // Disable all links on the page
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    links[i].addEventListener('click', function(event) {
      event.preventDefault();
      showMessage('Links are disabled during the exam.');
    });
  }

  // Custom function to display messages using SweetAlert
  function showMessage(message) {
    Swal.fire({
      toast: true,
      text: message,
      icon: 'warning',
      position: 'top-end',
      showConfirmButton: false,
      timer: 5000 // Auto close after 5 seconds
    });
  }
</script>

{% endblock %}
