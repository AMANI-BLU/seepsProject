{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link rel="stylesheet" href="{% static "fontawesome-free/css/all.min.css" %}">
    <!-- Ionicons -->
    <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <!-- Tempusdominus Bbootstrap 4 -->
    <link rel="stylesheet" href="{% static 'tempusdominus-bootstrap-4/css/tempusdominus-bootstrap-4.min.css' %}">
    <!-- iCheck -->
    <link rel="stylesheet" href="{% static "icheck-bootstrap/icheck-bootstrap.min.css" %}">
    <!-- JQVMap -->
    <link rel="stylesheet" href="{% static "jqvmap/jqvmap.min.css" %}">
    <!-- Theme style -->
    <link rel="stylesheet" href="{% static 'dist/css/adminlte.min.css'  %}">
    <!-- overlayScrollbars -->
    <link rel="stylesheet" href="{% static "overlayScrollbars/css/OverlayScrollbars.min.css" %}">
    <!-- Daterange picker -->
    <link rel="stylesheet" href="{% static "daterangepicker/daterangepicker.css" %}">
    <!-- summernote -->
    <link rel="stylesheet" href="{% static "summernote/summernote-bs4.css" %}">
    <link rel="stylesheet" href="{% static "plugins/sweetalert2-theme-bootstrap-4/bootstrap-4.min.css" %}">
    <!-- Toastr -->
    <link rel="stylesheet" href="{% static "plugins/toastr/toastr.min.css" %}">
    <!-- Theme style -->
    <!-- Google Font: Source Sans Pro -->
    <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700" rel="stylesheet">

    <!-- SweetAlert2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@10">
    <link rel="stylesheet" href="{% static "plugins/datatables-bs4/css/dataTables.bootstrap4.min.css" %}">
    <link rel="stylesheet" href="{% static "plugins/datatables-responsive/css/responsive.bootstrap4.min.css" %}">
    <link rel="stylesheet" href="{% static "plugins/datatables-buttons/css/buttons.bootstrap4.min.css" %}">

    <title>seeps</title>
    <style>
        .profile-img {
            width: 150px;
            height: 150px;
            object-fit: cover;
            border-radius: 50%;
            margin-bottom: 20px;
        }
    </style>
</head>
<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top shadow">
    <a href="#" class="navbar-brand">
        <h6 class="text-muted">Exam <span class="text-info">{{ exam.name }}</span></h6>
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
            aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ml-auto">
            <li class="nav-item">
                <span class="nav-link"><i class="far fa-clock mr-1"></i><span id="timer">--:--</span></span>
            </li>
            <li class="nav-item">
                <span class="nav-link"><i class="fas fa-exclamation-circle text-warning mr-1"></i>Attempts Remaining: <span
                        id="attemptsRemaining">{{ attempts_remaining }}</span></span>
            </li>
        </ul>
    </div>

    <div class="progress navbar-progress bg-info" role="progressbar" style="max-width: 50%;" aria-valuenow="100"
         aria-valuemin="0" aria-valuemax="100" id="timerProgressBar"></div>
</nav>


<body>
<div class="container mt-5 content-container">
    <div class="container mt-5">
        <div class="card p-3 mb-5 bg-white rounded" style="margin-top: 80px;">
            <div class="card-body">
 <form id="examForm" method="post" action="{% url 'submit_exam' exam.id %}">
                    {% csrf_token %}
                    {% for question in questions %}
                        <div class="card card-info mb-4">
                            <div class="card-header">
                                <h4 class="card-title mb-0">{{ forloop.counter }}) {{ question.content }}</h4>
                                <p class="text-muted">*{{ question.weight }}</p>
                            </div>
                            <div class="card-body">
                                <div class="list-group">
                                    {% if question.correct_choices_count > 1 %}
                                        {% for choice in question.choice_set.all %}
                                            <label class="list-group-item list-group-item-action">
                                                <div class="icheck-info d-inline">
                                                    <input type="checkbox" id="choice{{ choice.id }}"
                                                           name="question_{{ question.id }}[]" value="{{ choice.id }}">
                                                    <label for="choice{{ choice.id }}">{{ choice.text }}</label>
                                                </div>
                                            </label>
                                        {% endfor %}
                                    {% else %}
                                        {% for choice in question.choice_set.all %}
                                            <label class="list-group-item list-group-item-action">
                                                <div class="icheck-info d-inline">
                                                    <input type="radio" id="choice{{ choice.id }}"
                                                           name="question_{{ question.id }}" value="{{ choice.id }}">
                                                    <label for="choice{{ choice.id }}">{{ choice.text }}</label>
                                                </div>
                                            </label>
                                        {% endfor %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                    <div class="text-center">
                        <button type="submit" onclick="handleSubmit()" class="btn btn-info btn-lg">
                            <i class="fas fa-check-circle"></i> Submit Exam
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <script>
        // Function to handle form submission
        function handleSubmit() {
            // Clear progress data from localStorage for the current user
            const username = "{{ user.username }}";
            localStorage.removeItem('examProgress_' + username);
            localStorage.removeItem('timerValue_' + username); // Remove timer value from localStorage
        }

        var attemptsRemaining = document.getElementById('attemptsRemaining').innerText;

        var timerElement = document.getElementById('timer');
        var progressBar = document.getElementById('timerProgressBar');
        var username = "{{ user.username }}";
        var timerValue = localStorage.getItem('timerValue_' + username) ? parseInt(localStorage.getItem('timerValue_' + username)) : {{ exam.timer }} * 60;

        function updateTimer() {
            var minutes = Math.floor(timerValue / 60);
            var seconds = timerValue % 60;
            var progressPercentage = (timerValue / ({{ exam.timer }} * 60)) * 100;

            // Set timer text content
            timerElement.textContent = 'Time Remaining: ' + String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');

            // Set progress bar width
            progressBar.style.width = progressPercentage + '%';

            // Change progress bar color to red when 3 minutes left
            if (timerValue <= 180) {
                progressBar.classList.add('bg-danger');
            }

            if (timerValue === 0) {
                document.getElementById('examForm').submit();
                localStorage.removeItem('examProgress_' + username);
                localStorage.removeItem('timerValue_' + username);
            } else {
                timerValue--;
                localStorage.setItem('timerValue_' + username, timerValue); // Store timer value in localStorage
                setTimeout(updateTimer, 1000);
            }

            // Auto-save progress every 5 seconds
            if (timerValue % 5 === 0) {
                saveProgress();
            }
        }

        updateTimer();

        // Save progress
        function saveProgress() {
            const selectedAnswers = {};
            {% for question in questions %}
            var selectedOptions = document.querySelectorAll('input[name="question_{{ question.id }}[]"]:checked');
            if (selectedOptions.length > 0) {
                selectedAnswers[{{ question.id }}] = Array.from(selectedOptions).map(option => option.value);
            } else {
                var selectedOption = document.querySelector('input[name="question_{{ question.id }}"]:checked');
                if (selectedOption) {
                    selectedAnswers[{{ question.id }}] = selectedOption.value;
                }
            }
            {% endfor %}
            localStorage.setItem('examProgress_' + username, JSON.stringify(selectedAnswers));
        }

        // Load saved progress
        function loadProgress() {
            const savedProgress = localStorage.getItem('examProgress_' + username);
            if (savedProgress) {
                const selectedAnswers = JSON.parse(savedProgress);
                for (const questionId in selectedAnswers) {
                    const answer = selectedAnswers[questionId];
                    if (Array.isArray(answer)) {
                        answer.forEach(value => {
                            const option = document.querySelector(`input[name="question_${questionId}[]"][value="${value}"]`);
                            if (option) {
                                option.checked = true;
                            }
                        });
                    } else {
                        const option = document.querySelector(`input[name="question_${questionId}"][value="${answer}"]`);
                        if (option) {
                            option.checked = true;
                        }
                    }
                }
            }
        }

        // Call loadProgress when the page loads
        window.onload = loadProgress;
    </script>
</div>
</body>
</html>
